name: Preview readme files on PRs
on:
  pull_request:
    paths: '**/README.md'

jobs:
  preview-readme:
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
        - name: Checkout code
          uses: actions/checkout@v4
        - name: Preview readmes
          run: |
            python -m pip install --upgrade pip
            pip install -r testing-requirements.txt
            make readme-preview
        - name: Push readmes to a separate branch
          run: |
            export BRANCH="docspreview/pr-${{ github.event.pull_request.number }}"
            git config user.name github-actions
            git config user.email github-actions@github.com
            git switch --orphan ${BRANCH} || git checkout ${BRANCH}
            mv README.html collection-readme.html
            mv roles/tas_single_node/README.html role-readme.html
            git add collection-readme.html role-readme.html
            git commit -m "Update generated docs"
            echo git push --set-upstream origin ${BRANCH}

#        - uses: actions/upload-artifact@v4
#          id: collection-readme
#          with:
#            name: collection-readme
#            path: README.html
#        - uses: actions/upload-artifact@v4
#          id: role-readme
#          with:
#            name: role-readme
#            path: roles/tas_single_node/README.html
#        - uses: mshick/add-pr-comment@v2
#          with:
#            message-path: |
#              README.html
